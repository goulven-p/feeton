<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enregistrement Audio & Facturation</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 24px;
    }

    h2 {
      color: #555;
      margin-bottom: 20px;
      font-size: 18px;
      font-weight: 600;
    }

    .divider {
      height: 1px;
      background: #e0e0e0;
      margin: 20px 0;
    }

    /* Section Audio */
    .audio-controls {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin: 20px 0;
    }

    button {
      font-size: 16px;
      padding: 14px 28px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #start {
      background-color: #4CAF50;
      color: white;
    }

    #start:hover:not(:disabled) {
      background-color: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
    }

    #stop {
      background-color: #f44336;
      color: white;
    }

    #stop:hover:not(:disabled) {
      background-color: #da190b;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .status {
      margin-top: 20px;
      padding: 12px;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
      display: none;
    }

    .status.show {
      display: block;
    }

    .status.recording {
      background-color: #ffebee;
      color: #c62828;
      border: 2px solid #ef5350;
    }

    .status.success {
      background-color: #e8f5e9;
      color: #2e7d32;
      border: 2px solid #66bb6a;
    }

    .status.error {
      background-color: #ffebee;
      color: #c62828;
      border: 2px solid #ef5350;
    }

    /* Section Facturation */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 600;
    }

    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }

    .invoice-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    .invoice-section h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 16px;
    }

    .invoice-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .btn-invoice {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }

    .btn-invoice:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-invoice:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-invoice .icon {
      font-size: 24px;
    }

    .btn-invoice .label {
      font-size: 14px;
    }

    @media (max-width: 600px) {
      .audio-controls {
        flex-direction: column;
      }

      .invoice-buttons {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Section Enregistrement Audio -->
    <div class="card">
      <h1>üéôÔ∏è Enregistrement Audio</h1>
      <div class="divider"></div>
      
      <div class="audio-controls">
        <button id="start">
          <span>‚ñ∂Ô∏è</span>
          D√©marrer
        </button>
        <button id="stop" disabled>
          <span>‚èπÔ∏è</span>
          Arr√™ter
        </button>
      </div>
      
      <div id="audioStatus" class="status"></div>
    </div>

    <!-- Section Facturation -->
    <div class="card">
      <h1>üìã Facturation Patient</h1>
      <div class="divider"></div>
      
      <div class="form-group">
        <label for="patientName">Nom du patient *</label>
        <input 
          type="text" 
          id="patientName" 
          placeholder="Entrez le nom du patient"
          required
        >
      </div>

      <div class="invoice-section">
        <h3>Cr√©er une facture</h3>
        <div class="invoice-buttons">
          <button class="btn-invoice" id="btnBilan">
            <span class="icon">üìÑ</span>
            <span class="label">Bilan</span>
          </button>
          <button class="btn-invoice" id="btnBilanSemelles">
            <span class="icon">üë£</span>
            <span class="label">Bilan + Semelles</span>
          </button>
        </div>
      </div>

      <div id="invoiceStatus" class="status"></div>
    </div>
  </div>

  <script>
    // ============================================
    // CONFIGURATION DES WEBHOOKS
    // ============================================
    const WEBHOOK_AUDIO = "https://agoriade.app.n8n.cloud/webhook/8daae930-d4b3-4ac1-b70a-b030f37ad638";
    const WEBHOOK_BILAN = "https://agoriade.app.n8n.cloud/webhook/patient-document"; // √Ä MODIFIER
    const WEBHOOK_BILAN_SEMELLES = "https://agoriade.app.n8n.cloud/webhook/patient-document"; // √Ä MODIFIER

    // ============================================
    // GESTION ENREGISTREMENT AUDIO
    // ============================================
    let mediaRecorder;
    let audioChunks = [];
    let stream;

    function afficherStatutAudio(message, type = '') {
      const statusDiv = document.getElementById('audioStatus');
      statusDiv.textContent = message;
      statusDiv.className = 'status show ' + type;
    }

    document.getElementById("start").onclick = async () => {
      try {
        afficherStatutAudio('Demande d\'acc√®s au microphone...', '');
        
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) {
            audioChunks.push(e.data);
          }
        };

        mediaRecorder.onstop = async () => {
          try {
            afficherStatutAudio('Envoi de l\'audio...', '');
            
            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            const formData = new FormData();
            formData.append('file', blob, 'recording.webm');

            const response = await fetch(WEBHOOK_AUDIO, {
              method: "POST",
              body: formData
            });

            if (response.ok) {
              afficherStatutAudio('‚úÖ Audio envoy√© avec succ√®s !', 'success');
            } else {
              throw new Error(`Erreur serveur : ${response.status}`);
            }
          } catch (err) {
            afficherStatutAudio('‚ùå Erreur lors de l\'envoi : ' + err.message, 'error');
            console.error(err);
          } finally {
            arreterFluxAudio();
          }
        };

        mediaRecorder.start();
        afficherStatutAudio('üî¥ Enregistrement en cours...', 'recording');
        
        document.getElementById("start").disabled = true;
        document.getElementById("stop").disabled = false;

      } catch (err) {
        afficherStatutAudio('‚ùå Erreur d\'acc√®s au micro : ' + err.message, 'error');
        console.error(err);
      }
    };

    document.getElementById("stop").onclick = () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        document.getElementById("start").disabled = false;
        document.getElementById("stop").disabled = true;
      }
    };

    function arreterFluxAudio() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
    }

    window.addEventListener('beforeunload', () => {
      arreterFluxAudio();
    });

    // ============================================
    // GESTION FACTURATION
    // ============================================
    function afficherStatutFacture(message, type = '') {
      const statusDiv = document.getElementById('invoiceStatus');
      statusDiv.textContent = message;
      statusDiv.className = 'status show ' + type;
      
      setTimeout(() => {
        statusDiv.classList.remove('show');
      }, 5000);
    }

    async function envoyerFacture(type, webhookUrl) {
      const patientName = document.getElementById('patientName').value.trim();
      
      if (!patientName) {
        afficherStatutFacture('‚ö†Ô∏è Veuillez saisir le nom du patient', 'error');
        return;
      }

      try {
        afficherStatutFacture('Envoi en cours...', '');
        
        const response = await fetch(webhookUrl, {
          method: "POST",
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            patientName: patientName,
            type: type
          })
        });

        if (response.ok) {
          afficherStatutFacture(`‚úÖ Facture "${type}" cr√©√©e pour ${patientName}`, 'success');
          document.getElementById('patientName').value = '';
        } else {
          throw new Error(`Erreur serveur : ${response.status}`);
        }
      } catch (err) {
        afficherStatutFacture('‚ùå Erreur lors de l\'envoi : ' + err.message, 'error');
        console.error(err);
      }
    }

    document.getElementById('btnBilan').onclick = () => {
      envoyerFacture('Bilan', WEBHOOK_BILAN);
    };

    document.getElementById('btnBilanSemelles').onclick = () => {
      envoyerFacture('Bilan + Semelles', WEBHOOK_BILAN);
    };

    // Permettre l'envoi avec la touche Entr√©e
    document.getElementById('patientName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('btnBilan').click();
      }
    });
  </script>
</body>
</html>
